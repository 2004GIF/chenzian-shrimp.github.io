<!DOCTYPE html>
<html data-color-mode="light" data-dark-theme="dark" data-light-theme="light" lang="zh-CN">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href='https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/Primer/21.0.7/primer.css' rel='stylesheet' />
    
    <link rel="icon" href="https://github.githubassets.com/favicons/favicon.svg"><script>
        let theme = localStorage.getItem("meek_theme") || "light";
        document.documentElement.setAttribute("data-color-mode", theme);
    </script>
<meta name="description" content="ES（Elasticsearch）是一个基于Lucene构建的开源搜索引擎，主要用于处理搜索、分析和存储大量数据。">
<meta property="og:title" content="es 笔记">
<meta property="og:description" content="ES（Elasticsearch）是一个基于Lucene构建的开源搜索引擎，主要用于处理搜索、分析和存储大量数据。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://2004GIF.github.io/chenzian-shrimp.github.io/post/es%20-bi-ji.html">
<meta property="og:image" content="https://github.githubassets.com/favicons/favicon.svg">
<title>es 笔记</title>
<link href="//unpkg.com/@wooorm/starry-night@2.1.1/style/both.css" rel="stylesheet" />


</head>
<style>
body{box-sizing: border-box;min-width: 200px;max-width: 900px;margin: 20px auto;padding: 45px;font-size: 16px;font-family: sans-serif;line-height: 1.25;}
#header{display:flex;padding-bottom:8px;border-bottom: 1px solid var(--borderColor-muted, var(--color-border-muted));margin-bottom: 16px;}
#footer {margin-top:64px; text-align: center;font-size: small;}

</style>

<style>
.postTitle{margin: auto 0;font-size:40px;font-weight:bold;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}
#postBody{border-bottom: 1px solid var(--color-border-default);padding-bottom:36px;}
#postBody hr{height:2px;}
#cmButton{height:48px;margin-top:48px;}
#comments{margin-top:64px;}
.g-emoji{font-size:24px;}
@media (max-width: 600px) {
    body {padding: 8px;}
    .postTitle{font-size:24px;}
}
.copy-feedback {
    display: none;
    position: absolute;
    top: 10px;
    right: 50px;
    color: var(--color-fg-on-emphasis);
    background-color: var(--color-fg-muted);
    border-radius: 3px;
    padding: 5px 8px;
    font-size: 12px;
}
</style>




<body>
    <div id="header">
<h1 class="postTitle">es 笔记</h1>
<div class="title-right">
    <a href="https://2004GIF.github.io/chenzian-shrimp.github.io" id="buttonHome" class="btn btn-invisible circle" title="首页">
        <svg class="octicon" width="16" height="16">
            <path id="pathHome" fill-rule="evenodd"></path>
        </svg>
    </a>
    
    <a href="https://github.com/2004GIF/chenzian-shrimp.github.io/issues/10" target="_blank" class="btn btn-invisible circle" title="Issue">
        <svg class="octicon" width="16" height="16">
            <path id="pathIssue" fill-rule="evenodd"></path>
        </svg>
    </a>
    

    <a class="btn btn-invisible circle" onclick="modeSwitch();" title="切换主题">
        <svg class="octicon" width="16" height="16" >
            <path id="themeSwitch" fill-rule="evenodd"></path>
        </svg>
    </a>

</div>
</div>
    <div id="content">
<div class="markdown-body" id="postBody"><p>ES（Elasticsearch）是一个基于Lucene构建的开源搜索引擎，主要用于处理搜索、分析和存储大量数据。<br>
elasticsearch之所以有如此高性能的搜索表现，正是得益于底层的倒排索引技术。<br>
正向索引：先找到文档（一条数据），在匹配内容<br>
倒排索引：通过词条来找文档（一条数据）<br>
总结：<br>
正向索引：</p>
<ul>
<li>优点：
<ul>
<li>可以给多个字段创建索引</li>
<li>根据索引字段搜索、排序速度非常快</li>
</ul>
</li>
<li>缺点：
<ul>
<li>根据非索引字段，或者索引字段中的部分词条查找时，只能全表扫描。</li>
</ul>
</li>
</ul>
<p>倒排索引：</p>
<ul>
<li>优点：
<ul>
<li>根据词条搜索、模糊搜索时，速度非常快</li>
</ul>
</li>
<li>缺点：
<ul>
<li>只能给词条创建索引，而不是字段</li>
<li>无法根据字段做排序</li>
</ul>
</li>
</ul>
<p>倒排索引中有两个非常重要的概念：</p>
<ul>
<li>文档（Document）：用来搜索的数据，其中的每一条数据就是一个文档。例如一个网页、一个商品信息</li>
<li>词条（Term）：对文档数据或用户搜索数据，利用某种算法分词，得到的具备含义的词语就是词条。例如：我是中国人，就可以分为：我、是、中国人、中国、国人这样的几个词条</li>
</ul>
<p>使用 es  来进行关键字搜索流程：</p>
<ol>
<li>对 es 中 text 类型的数据进行分词，保存到一个词库中，词库中保存词条和文档的对应关系</li>
<li>对用户输入的内容进行分词</li>
<li>根据分好词的词条去词库中匹配，获取匹配成功的文档id</li>
<li>根据获取到的文档id来收集好数据，进行返回<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/2004GIF/chenzian-shrimp.github.io/assets/126451952/50430132-32fa-4e61-adae-9fcb0ca63cbe"><img src="https://github.com/2004GIF/chenzian-shrimp.github.io/assets/126451952/50430132-32fa-4e61-adae-9fcb0ca63cbe" alt="download_image(4)" style="max-width: 100%;"></a></li>
</ol>
<p>索引库操作<br>
Index就类似数据库表，Mapping映射就类似表的结构。我们要向es中存储数据，必须先创建Index和Mapping</p>
<p>Mapping映射属性<br>
Mapping是对索引库中文档的约束，常见的Mapping属性包括：</p>
<ul>
<li>type：字段数据类型，常见的简单类型有：
<ul>
<li>字符串：text（可分词的文本）、keyword（精确值，例如：品牌、国家、ip地址）</li>
<li>数值：long、integer、short、byte、double、float、</li>
<li>布尔：boolean</li>
<li>日期：date</li>
<li>对象：object</li>
</ul>
</li>
<li>index：是否创建索引，默认为true</li>
<li>analyzer：使用哪种分词器</li>
<li>properties：该字段的子字段</li>
</ul>
<p>示例：</p>
<div class="highlight highlight-source-json"><pre class="notranslate"><span class="pl-ii"># PUT /heima</span>
{
  <span class="pl-ent">"mappings"</span>: {
    <span class="pl-ent">"properties"</span>: {
      <span class="pl-ent">"info"</span>:{
        <span class="pl-ent">"type"</span>: <span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span>,
        <span class="pl-ent">"analyzer"</span>: <span class="pl-s"><span class="pl-pds">"</span>ik_smart<span class="pl-pds">"</span></span>
      },
      <span class="pl-ent">"email"</span>:{
        <span class="pl-ent">"type"</span>: <span class="pl-s"><span class="pl-pds">"</span>keyword<span class="pl-pds">"</span></span>,
        <span class="pl-ent">"index"</span>: <span class="pl-s"><span class="pl-pds">"</span>false<span class="pl-pds">"</span></span>
      },
      <span class="pl-ent">"name"</span>:{
        <span class="pl-ent">"properties"</span>: {
          <span class="pl-ent">"firstName"</span>: {
            <span class="pl-ent">"type"</span>: <span class="pl-s"><span class="pl-pds">"</span>keyword<span class="pl-pds">"</span></span>
          }
        }
      }
    }
  }
}</pre></div>
<h3>索引库操作</h3>
<h4>新增索引</h4>
<p>控制台：</p>
<div class="highlight highlight-source-json"><pre class="notranslate"><span class="pl-ii">PUT /items   //  Restful API  接口</span>
{
  <span class="pl-ent">"mappings"</span>: {   <span class="pl-ii">//  映射，其实就是对字段的约束</span>
    <span class="pl-ent">"properties"</span>: {
       <span class="pl-ent">"id"</span>:{   <span class="pl-ii">// 字段名</span>
         <span class="pl-ent">"type"</span>: <span class="pl-s"><span class="pl-pds">"</span>keyword<span class="pl-pds">"</span></span> <span class="pl-ii">// 使用的类型 keyword </span>
       },
       <span class="pl-ent">"info"</span>:{
         <span class="pl-ent">"type"</span>: <span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span>,
         <span class="pl-ent">"analyzer"</span>: <span class="pl-s"><span class="pl-pds">"</span>ik_smart<span class="pl-pds">"</span></span>
       }
    }
  }
}
</pre></div>
<p>java API：</p>
<div class="highlight highlight-source-java"><pre class="notranslate">  <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testCreateIndex</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-c">// 1. 准备request</span>
        <span class="pl-smi">CreateIndexRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">CreateIndexRequest</span>(<span class="pl-s">"items"</span>);
        <span class="pl-c">// 2. 准备请求参数</span>
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>(<span class="pl-c1">MAPPING_TEMPLATE</span>, <span class="pl-smi">XContentType</span>.<span class="pl-c1">JSON</span>);
        <span class="pl-c">// 3. 发送请求 client.indices() 获取操作索引库的客户端对象</span>
        <span class="pl-s1">client</span>.<span class="pl-en">indices</span>().<span class="pl-en">create</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);
    }

<span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-c1">MAPPING_TEMPLATE</span> = <span class="pl-s">"{<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"  <span class="pl-cce">\"</span>mappings<span class="pl-cce">\"</span>: {<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"    <span class="pl-cce">\"</span>properties<span class="pl-cce">\"</span>: {<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      <span class="pl-cce">\"</span>id<span class="pl-cce">\"</span>: {<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>type<span class="pl-cce">\"</span>: <span class="pl-cce">\"</span>keyword<span class="pl-cce">\"</span><span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      },<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      <span class="pl-cce">\"</span>name<span class="pl-cce">\"</span>:{<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>type<span class="pl-cce">\"</span>: <span class="pl-cce">\"</span>text<span class="pl-cce">\"</span>,<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>analyzer<span class="pl-cce">\"</span>: <span class="pl-cce">\"</span>ik_max_word<span class="pl-cce">\"</span><span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      },<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      <span class="pl-cce">\"</span>price<span class="pl-cce">\"</span>:{<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>type<span class="pl-cce">\"</span>: <span class="pl-cce">\"</span>integer<span class="pl-cce">\"</span><span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      },<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      <span class="pl-cce">\"</span>stock<span class="pl-cce">\"</span>:{<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>type<span class="pl-cce">\"</span>: <span class="pl-cce">\"</span>integer<span class="pl-cce">\"</span><span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      },<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      <span class="pl-cce">\"</span>image<span class="pl-cce">\"</span>:{<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>type<span class="pl-cce">\"</span>: <span class="pl-cce">\"</span>keyword<span class="pl-cce">\"</span>,<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>index<span class="pl-cce">\"</span>: false<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      },<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      <span class="pl-cce">\"</span>category<span class="pl-cce">\"</span>:{<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>type<span class="pl-cce">\"</span>: <span class="pl-cce">\"</span>keyword<span class="pl-cce">\"</span><span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      },<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      <span class="pl-cce">\"</span>brand<span class="pl-cce">\"</span>:{<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>type<span class="pl-cce">\"</span>: <span class="pl-cce">\"</span>keyword<span class="pl-cce">\"</span><span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      },<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      <span class="pl-cce">\"</span>sold<span class="pl-cce">\"</span>:{<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>type<span class="pl-cce">\"</span>: <span class="pl-cce">\"</span>integer<span class="pl-cce">\"</span><span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      },<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      <span class="pl-cce">\"</span>commentCount<span class="pl-cce">\"</span>:{<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>type<span class="pl-cce">\"</span>: <span class="pl-cce">\"</span>integer<span class="pl-cce">\"</span><span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      },<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      <span class="pl-cce">\"</span>isAD<span class="pl-cce">\"</span>:{<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>type<span class="pl-cce">\"</span>: <span class="pl-cce">\"</span>boolean<span class="pl-cce">\"</span><span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      },<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      <span class="pl-cce">\"</span>updateTime<span class="pl-cce">\"</span>:{<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"        <span class="pl-cce">\"</span>type<span class="pl-cce">\"</span>: <span class="pl-cce">\"</span>date<span class="pl-cce">\"</span><span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"      }<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"    }<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"  }<span class="pl-cce">\n</span>"</span> +
            <span class="pl-s">"}"</span>;
</pre></div>
<h4>删除索引库</h4>
<p>控制台：</p>
<div class="highlight highlight-source-json"><pre class="notranslate"><span class="pl-ii">DELETE  /items</span></pre></div>
<p>Java :</p>
<div class="highlight highlight-source-java"><pre class="notranslate">  <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testDeleteIndex</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-smi">DeleteIndexRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">DeleteIndexRequest</span>(<span class="pl-s">"items"</span>);
        <span class="pl-s1">client</span>.<span class="pl-en">indices</span>().<span class="pl-en">delete</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);
    }</pre></div>
<h4>获取索引库信息</h4>
<p>控制台</p>
<div class="highlight highlight-source-json"><pre class="notranslate"><span class="pl-ii">GET /item</span></pre></div>
<p>Java：</p>
<div class="highlight highlight-source-java"><pre class="notranslate"> <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testGetIndex</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-smi">GetIndexRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">GetIndexRequest</span>(<span class="pl-s">"items"</span>);
       <span class="pl-c">// 这里是在判断的索引库是否存在，如果直接获取索引库信息还需要自己进行解析</span>
        <span class="pl-smi">boolean</span> <span class="pl-s1">exists</span> = <span class="pl-s1">client</span>.<span class="pl-en">indices</span>().<span class="pl-en">exists</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);  
        <span class="pl-smi">System</span>.<span class="pl-s1">out</span>.<span class="pl-en">println</span>(<span class="pl-s">"exists = "</span> + <span class="pl-s1">exists</span>); 
    }</pre></div>
<h4>修改索引库（只能给索引库新增字段，不能修改原来的字段）</h4>
<p>控制台：</p>
<div class="highlight highlight-source-json"><pre class="notranslate"><span class="pl-ii">PUT /my_user/_mapping</span>
{
  <span class="pl-ent">"properties"</span>:{
    <span class="pl-ent">"username"</span>:{
      <span class="pl-ent">"type"</span>: <span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span>
    }
  }
}
</pre></div>
<p>java : 略</p>
<h3>操作文档</h3>
<h4>新增文档</h4>
<p>控制台：</p>
<div class="highlight highlight-source-json"><pre class="notranslate"><span class="pl-ii">POST /my_user/_doc/1   // /索引库名/_doc/文档的id （不写自动生成）</span>
{
  <span class="pl-ent">"age"</span>: <span class="pl-c1">12</span> ,
  <span class="pl-ent">"info"</span>: <span class="pl-s"><span class="pl-pds">"</span>是一个好人<span class="pl-pds">"</span></span>,
  <span class="pl-ent">"name"</span>:{
    <span class="pl-ent">"firstName"</span>:<span class="pl-s"><span class="pl-pds">"</span>赵<span class="pl-pds">"</span></span>,
    <span class="pl-ent">"lastName"</span>: <span class="pl-s"><span class="pl-pds">"</span>云<span class="pl-pds">"</span></span>
  }
}
</pre></div>
<p>Java：</p>
<div class="highlight highlight-source-java"><pre class="notranslate">  <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testCreateDoc</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-c">// 0. 准备 json 数据</span>
        <span class="pl-smi">Item</span> <span class="pl-s1">item</span> = <span class="pl-s1">itemService</span>.<span class="pl-en">getById</span>(<span class="pl-c1">317578L</span>);
        <span class="pl-smi">ItemDoc</span> <span class="pl-s1">itemDoc</span> = <span class="pl-smi">BeanUtil</span>.<span class="pl-en">copyProperties</span>(<span class="pl-s1">item</span>, <span class="pl-smi">ItemDoc</span>.<span class="pl-k">class</span>);
        <span class="pl-s1">itemDoc</span>.<span class="pl-en">setCommentCount</span>(<span class="pl-c1">0</span>);
        <span class="pl-c">// 1. 准备 request</span>
        <span class="pl-smi">IndexRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">IndexRequest</span>(<span class="pl-s">"items"</span>).<span class="pl-en">id</span>(<span class="pl-s1">itemDoc</span>.<span class="pl-en">getId</span>());

        <span class="pl-c">// 2. 准备请求参数</span>
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>(<span class="pl-smi">JSONUtil</span>.<span class="pl-en">toJsonStr</span>(<span class="pl-s1">itemDoc</span>), <span class="pl-smi">XContentType</span>.<span class="pl-c1">JSON</span>);

        <span class="pl-c">// 3. 发送请求</span>
        <span class="pl-smi">IndexResponse</span> <span class="pl-s1">response</span> = <span class="pl-s1">client</span>.<span class="pl-en">index</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);
        <span class="pl-smi">System</span>.<span class="pl-s1">out</span>.<span class="pl-en">println</span>(<span class="pl-s">"response = "</span> + <span class="pl-s1">response</span>);

    }
```

#### 获取文档
````<span class="pl-smi">json</span>
<span class="pl-c1">GET</span> /<span class="pl-s1">items</span>/<span class="pl-s1">_doc</span>/<span class="pl-c1">1</span>   <span class="pl-c">// 获取items索引库中id为1的文档数据</span></pre></div>
<p>Java：</p>
<div class="highlight highlight-source-java"><pre class="notranslate">    <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testGetDoc</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-c">// 1. 准备 request</span>
        <span class="pl-smi">GetRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">GetRequest</span>(<span class="pl-s">"items"</span>, <span class="pl-s">"317578"</span>);
        <span class="pl-c">// 2. 发送请求</span>
        <span class="pl-smi">GetResponse</span> <span class="pl-s1">response</span> = <span class="pl-s1">client</span>.<span class="pl-en">get</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);
        <span class="pl-c">// 3. 解析结果</span>
        <span class="pl-smi">String</span> <span class="pl-s1">json</span> = <span class="pl-s1">response</span>.<span class="pl-en">getSourceAsString</span>();
        <span class="pl-smi">ItemDoc</span> <span class="pl-s1">itemDoc</span> = <span class="pl-smi">JSONUtil</span>.<span class="pl-en">toBean</span>(<span class="pl-s1">json</span>, <span class="pl-smi">ItemDoc</span>.<span class="pl-k">class</span>);
        <span class="pl-smi">System</span>.<span class="pl-s1">out</span>.<span class="pl-en">println</span>(<span class="pl-s">"itemDoc = "</span> + <span class="pl-s1">itemDoc</span>);
    }</pre></div>
<h4>删除文档</h4>
<p>控制台：</p>
<div class="highlight highlight-source-json"><pre class="notranslate"><span class="pl-ii">DELETE /items/_doc/1   // 删除id为1的文档</span></pre></div>
<p>Java ：</p>
<div class="highlight highlight-source-java"><pre class="notranslate"> <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testDelDoc</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-smi">DeleteRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">DeleteRequest</span>(<span class="pl-s">"items"</span>, <span class="pl-s">"317578"</span>);

        <span class="pl-s1">client</span>.<span class="pl-en">delete</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);
    }</pre></div>
<h4>修改文档</h4>
<h5>全量修改 （覆盖原来的文档 , 新增或者修改，主要看id是否存在）</h5>
<p>控制台：</p>
<div class="highlight highlight-source-json"><pre class="notranslate"><span class="pl-ii"># 全量修改（全局修改 ， 如果id存在修改文档，如果id不存在新增文档）</span>
<span class="pl-ii">PUT /my_user/_doc/2</span>
{
  <span class="pl-ent">"age"</span>: <span class="pl-c1">19</span>,
  <span class="pl-ent">"info"</span>: <span class="pl-s"><span class="pl-pds">"</span>是一个好人<span class="pl-pds">"</span></span>,
  <span class="pl-ent">"name"</span>: {
    <span class="pl-ent">"firstName"</span>: <span class="pl-s"><span class="pl-pds">"</span>赵<span class="pl-pds">"</span></span>,
    <span class="pl-ent">"lastName"</span>: <span class="pl-s"><span class="pl-pds">"</span>拔<span class="pl-pds">"</span></span>
  }
}</pre></div>
<p>Java：</p>
<div class="highlight highlight-source-java"><pre class="notranslate">  <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testCreateDoc</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-c">// 0. 准备 json 数据</span>
        <span class="pl-smi">Item</span> <span class="pl-s1">item</span> = <span class="pl-s1">itemService</span>.<span class="pl-en">getById</span>(<span class="pl-c1">317578L</span>);
        <span class="pl-smi">ItemDoc</span> <span class="pl-s1">itemDoc</span> = <span class="pl-smi">BeanUtil</span>.<span class="pl-en">copyProperties</span>(<span class="pl-s1">item</span>, <span class="pl-smi">ItemDoc</span>.<span class="pl-k">class</span>);
        <span class="pl-s1">itemDoc</span>.<span class="pl-en">setCommentCount</span>(<span class="pl-c1">0</span>);
        <span class="pl-c">// 1. 准备 request</span>
        <span class="pl-smi">IndexRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">IndexRequest</span>(<span class="pl-s">"items"</span>).<span class="pl-en">id</span>(<span class="pl-s1">itemDoc</span>.<span class="pl-en">getId</span>());

        <span class="pl-c">// 2. 准备请求参数</span>
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>(<span class="pl-smi">JSONUtil</span>.<span class="pl-en">toJsonStr</span>(<span class="pl-s1">itemDoc</span>), <span class="pl-smi">XContentType</span>.<span class="pl-c1">JSON</span>);

        <span class="pl-c">// 3. 发送请求</span>
        <span class="pl-smi">IndexResponse</span> <span class="pl-s1">response</span> = <span class="pl-s1">client</span>.<span class="pl-en">index</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);
        <span class="pl-smi">System</span>.<span class="pl-s1">out</span>.<span class="pl-en">println</span>(<span class="pl-s">"response = "</span> + <span class="pl-s1">response</span>);

    }</pre></div>
<h5>定量修改  （修改文档中某个值）</h5>
<p>控制台：</p>
<div class="highlight highlight-source-json"><pre class="notranslate"><span class="pl-ii"># 定量修改（局部修改）</span>
<span class="pl-ii">POST /my_user/_update/1</span>
{
  <span class="pl-ent">"doc"</span>: {
    <span class="pl-ent">"age"</span>: <span class="pl-c1">100</span>
  }
}
</pre></div>
<p>Java：</p>
<div class="highlight highlight-source-java"><pre class="notranslate"><span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testUpdateDoc</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-smi">UpdateRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">UpdateRequest</span>(<span class="pl-s">"items"</span>, <span class="pl-s">"317578"</span>);
        <span class="pl-smi">Map</span>&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt; <span class="pl-s1">map</span> = <span class="pl-k">new</span> <span class="pl-smi">HashMap</span>&lt;&gt;();
        <span class="pl-s1">map</span>.<span class="pl-en">put</span>(<span class="pl-s">"price"</span>, <span class="pl-c1">30000</span>);
        <span class="pl-s1">map</span>.<span class="pl-en">put</span>(<span class="pl-s">"commentCount"</span>, <span class="pl-c1">10</span>);
        <span class="pl-s1">request</span>.<span class="pl-en">doc</span>(<span class="pl-s1">map</span>);
        <span class="pl-s1">client</span>.<span class="pl-en">update</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);
    }</pre></div>
<h3>对文档的批量操作</h3>
<h4>新增</h4>
<p>控制台：</p>
<pre class="notranslate"><code class="notranslate"># 批量新增
POST /_bulk
{"index": {"_index": "my_user" , "_id": 3}}
{"age": 22 , "info":"是一个好人" , "name": { "firstName": "李" ,"lastName": "四" }}
{"index": {"_index": "my_user" , "_id": 5}}
{"age": 22 , "info":"是一个好人" , "name": { "firstName": "王" ,"lastName": "五" }}

</code></pre>
<p>Java：</p>
<div class="highlight highlight-source-java"><pre class="notranslate"> <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testBulkAddDoc</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-smi">Page</span>&lt;<span class="pl-smi">Item</span>&gt; <span class="pl-s1">page</span> = <span class="pl-smi">Page</span>.<span class="pl-en">of</span>(<span class="pl-c1">1</span>, <span class="pl-c1">5</span>);
        <span class="pl-s1">itemService</span>.<span class="pl-en">page</span>(<span class="pl-s1">page</span>);
        <span class="pl-smi">List</span>&lt;<span class="pl-smi">Item</span>&gt; <span class="pl-s1">itemList</span> = <span class="pl-s1">page</span>.<span class="pl-en">getRecords</span>();
        <span class="pl-smi">List</span>&lt;<span class="pl-smi">ItemDoc</span>&gt; <span class="pl-s1">itemDocs</span> = <span class="pl-smi">BeanUtil</span>.<span class="pl-en">copyToList</span>(<span class="pl-s1">itemList</span>, <span class="pl-smi">ItemDoc</span>.<span class="pl-k">class</span>);
   
        <span class="pl-smi">BulkRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">BulkRequest</span>();
        <span class="pl-c">// 在 BulkReust 对象中添加其他操作的对象就可以完成批量操作了，必须可以信息 DeleteRequest 、UpdateRequest、IndexRequest </span>
        <span class="pl-c">// 其他其他的request 对象</span>
        <span class="pl-k">for</span> (<span class="pl-smi">ItemDoc</span> <span class="pl-s1">itemDoc</span> : <span class="pl-s1">itemDocs</span>) {
            <span class="pl-smi">IndexRequest</span> <span class="pl-s1">indexRequest</span> = <span class="pl-k">new</span> <span class="pl-smi">IndexRequest</span>(<span class="pl-s">"items"</span>).<span class="pl-en">id</span>(<span class="pl-s1">itemDoc</span>.<span class="pl-en">getId</span>()).<span class="pl-en">source</span>(<span class="pl-smi">JSONUtil</span>.<span class="pl-en">toJsonStr</span>(<span class="pl-s1">itemDoc</span>), <span class="pl-smi">XContentType</span>.<span class="pl-c1">JSON</span>);
            <span class="pl-s1">request</span>.<span class="pl-en">add</span>(<span class="pl-s1">indexRequest</span>);
        }

        <span class="pl-s1">client</span>.<span class="pl-en">bulk</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);
    }</pre></div>
<h2>使用DSL 语句来查询</h2>
<p>Elasticsearch的查询可以分为两大类：</p>
<ul>
<li>叶子查询（Leaf query clauses）：一般是在特定的字段里查询特定值，属于简单查询，很少单独使用。</li>
<li>复合查询（Compound query clauses）：以逻辑方式组合多个叶子查询或者更改叶子查询的行为方式。</li>
</ul>
<p>叶子查询：</p>
<ul>
<li>全文检索查询（Full Text Queries）：利用分词器对用户输入搜索条件先分词，得到词条，然后再利用倒排索引搜索词条。例如：
<ul>
<li>match：</li>
<li>multi_match</li>
</ul>
</li>
<li>精确查询（Term-level queries）：不对用户输入搜索条件分词，根据字段内容精确值匹配。但只能查找keyword、数值、日期、boolean类型的字段。例如：
<ul>
<li>ids</li>
<li>term</li>
<li>range</li>
</ul>
</li>
<li>地理坐标查询：用于搜索地理位置，搜索方式很多，例如：
<ul>
<li>geo_bounding_box：按矩形搜索</li>
<li>geo_distance：按点和半径搜索</li>
</ul>
</li>
</ul>
<h3>全文检索查询</h3>
<p>利用分词器对用户输入搜索条件先分词，得到词条，然后再利用倒排索引搜索词条。比如：match 、    multi_match</p>
<h4>match 查询 ---&gt; 针对可分词的字段</h4>
<p>控制台：</p>
<pre class="notranslate"><code class="notranslate">GET /items/_search
{
  "query": {
    "match": {
      "brand": "华为"
    }
  }
}
</code></pre>
<p>Java：</p>
<div class="highlight highlight-source-java"><pre class="notranslate">  <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testSearchMatch</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-c">// 1. 准备 request 对象</span>
        <span class="pl-smi">SearchRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">SearchRequest</span>(<span class="pl-s">"items"</span>);
        <span class="pl-c">// 2. 准备请求参数 QueryBuilders.matchQuery("name" , "华为") 一个字段模糊查询 参数一：字段名 参数二：关键字</span>
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>().<span class="pl-en">query</span>(<span class="pl-smi">QueryBuilders</span>.<span class="pl-en">matchQuery</span>(<span class="pl-s">"name"</span> , <span class="pl-s">"华为"</span>));
        <span class="pl-c">// QueryBuilders.multiMatchQuery("华为", "name" , "brand") ， 参数一：关键字 参数二：多个字段</span>
<span class="pl-c">//        request.source().query(QueryBuilders.multiMatchQuery("华为", "name", "brand"));</span>
        <span class="pl-c">// 3. 发送请求</span>
        <span class="pl-smi">SearchResponse</span> <span class="pl-s1">response</span> = <span class="pl-s1">client</span>.<span class="pl-en">search</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);

        <span class="pl-c">// 4.解析结果</span>
        <span class="pl-smi">SearchHits</span> <span class="pl-s1">hits</span> = <span class="pl-s1">response</span>.<span class="pl-en">getHits</span>();
        <span class="pl-smi">long</span> <span class="pl-s1">total</span> = <span class="pl-s1">hits</span>.<span class="pl-en">getTotalHits</span>().<span class="pl-s1">value</span>;
        <span class="pl-smi">System</span>.<span class="pl-s1">out</span>.<span class="pl-en">println</span>(<span class="pl-s">"total = "</span> + <span class="pl-s1">total</span>);
        <span class="pl-smi">SearchHit</span>[] <span class="pl-s1">searchHits</span> = <span class="pl-s1">hits</span>.<span class="pl-en">getHits</span>();
        <span class="pl-k">for</span> (<span class="pl-smi">SearchHit</span> <span class="pl-s1">searchHit</span> : <span class="pl-s1">searchHits</span>) {
            <span class="pl-smi">String</span> <span class="pl-s1">json</span> = <span class="pl-s1">searchHit</span>.<span class="pl-en">getSourceAsString</span>();
            <span class="pl-smi">System</span>.<span class="pl-s1">out</span>.<span class="pl-en">println</span>(<span class="pl-s">"每一条数据： "</span> + <span class="pl-s1">json</span>);
        }
    }</pre></div>
<p>查询结果</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/2004GIF/chenzian-shrimp.github.io/assets/126451952/244e5a06-70e1-4705-88b1-db16ecff0fde"><img src="https://github.com/2004GIF/chenzian-shrimp.github.io/assets/126451952/244e5a06-70e1-4705-88b1-db16ecff0fde" alt="download_image" style="max-width: 100%;"></a></p>
<p>Java：解析结果函数</p>
<div class="highlight highlight-source-java"><pre class="notranslate"><span class="pl-s1">List</span>&lt;<span class="pl-s1">ItemDoc</span>&gt; <span class="pl-en">handlerResponse</span>(<span class="pl-smi">SearchResponse</span> <span class="pl-s1">response</span>) {
        <span class="pl-smi">List</span>&lt;<span class="pl-smi">ItemDoc</span>&gt; <span class="pl-s1">result</span> = <span class="pl-k">new</span> <span class="pl-smi">ArrayList</span>&lt;&gt;();
        <span class="pl-smi">SearchHits</span> <span class="pl-s1">responseHits</span> = <span class="pl-s1">response</span>.<span class="pl-en">getHits</span>();
        <span class="pl-smi">long</span> <span class="pl-s1">total</span> = <span class="pl-s1">responseHits</span>.<span class="pl-en">getTotalHits</span>().<span class="pl-s1">value</span>;
        <span class="pl-smi">System</span>.<span class="pl-s1">out</span>.<span class="pl-en">println</span>(<span class="pl-s">"total = "</span> + <span class="pl-s1">total</span>);
        <span class="pl-smi">SearchHit</span>[] <span class="pl-s1">hits</span> = <span class="pl-s1">responseHits</span>.<span class="pl-en">getHits</span>();
        <span class="pl-k">for</span> (<span class="pl-smi">SearchHit</span> <span class="pl-s1">hit</span> : <span class="pl-s1">hits</span>) {
            <span class="pl-smi">String</span> <span class="pl-s1">json</span> = <span class="pl-s1">hit</span>.<span class="pl-en">getSourceAsString</span>();
            <span class="pl-smi">ItemDoc</span> <span class="pl-s1">itemDoc</span> = <span class="pl-smi">JSONUtil</span>.<span class="pl-en">toBean</span>(<span class="pl-s1">json</span>, <span class="pl-smi">ItemDoc</span>.<span class="pl-k">class</span>);

            <span class="pl-smi">Map</span>&lt;<span class="pl-smi">String</span>, <span class="pl-smi">HighlightField</span>&gt; <span class="pl-s1">hfs</span> = <span class="pl-s1">hit</span>.<span class="pl-en">getHighlightFields</span>();

            <span class="pl-k">if</span> (<span class="pl-smi">CollUtil</span>.<span class="pl-en">isNotEmpty</span>(<span class="pl-s1">hfs</span>)) {
                <span class="pl-smi">HighlightField</span> <span class="pl-s1">hf</span> = <span class="pl-s1">hfs</span>.<span class="pl-en">get</span>(<span class="pl-s">"name"</span>);
                <span class="pl-smi">StringBuilder</span> <span class="pl-s1">sb</span> = <span class="pl-k">new</span> <span class="pl-smi">StringBuilder</span>();
                <span class="pl-c">// 注意高亮的返回的结果是一个数组，如果设置高亮的内容过长 es 在底层会对结果进行分片</span>
                <span class="pl-smi">Text</span>[] <span class="pl-s1">fragments</span> = <span class="pl-s1">hf</span>.<span class="pl-en">getFragments</span>();
                <span class="pl-k">for</span> (<span class="pl-smi">Text</span> <span class="pl-s1">fragment</span> : <span class="pl-s1">fragments</span>) {
                    <span class="pl-s1">sb</span>.<span class="pl-en">append</span>(<span class="pl-s1">fragment</span>.<span class="pl-en">string</span>());
                }
                <span class="pl-s1">itemDoc</span>.<span class="pl-en">setName</span>(<span class="pl-s1">sb</span>.<span class="pl-en">toString</span>());
            }

            <span class="pl-s1">result</span>.<span class="pl-en">add</span>(<span class="pl-s1">itemDoc</span>);
        }
        <span class="pl-k">return</span> <span class="pl-s1">result</span>;
    }</pre></div>
<h4>multi_match查询 ---&gt; 针对可分词的字段</h4>
<p>控制台</p>
<pre class="notranslate"><code class="notranslate">GET /items/_search
{
  "query": {
    "multi_match": {
      "query": "华为",
      "fields": [ "name" ,"brand" ]
    }
  }
}
</code></pre>
<p>Java：</p>
<div class="highlight highlight-source-java"><pre class="notranslate"><span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testSearchMatch</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-c">// 1. 准备 request 对象</span>
        <span class="pl-smi">SearchRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">SearchRequest</span>(<span class="pl-s">"items"</span>);
        <span class="pl-c">// 2. 准备请求参数 QueryBuilders.matchQuery("name" , "华为") 一个字段模糊查询 参数一：字段名 参数二：关键字</span>
<span class="pl-c">//        request.source().query(QueryBuilders.matchQuery("name" , "华为"));</span>
<span class="pl-c">//         QueryBuilders.multiMatchQuery("华为", "name" , "brand") ， 参数一：关键字 参数二：多个字段</span>
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>().<span class="pl-en">query</span>(<span class="pl-smi">QueryBuilders</span>.<span class="pl-en">multiMatchQuery</span>(<span class="pl-s">"华为"</span>, <span class="pl-s">"name"</span>, <span class="pl-s">"brand"</span>));
        <span class="pl-c">// 3. 发送请求</span>
        <span class="pl-smi">SearchResponse</span> <span class="pl-s1">response</span> = <span class="pl-s1">client</span>.<span class="pl-en">search</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);

        <span class="pl-c">// 4.解析结果</span>
        <span class="pl-smi">SearchHits</span> <span class="pl-s1">hits</span> = <span class="pl-s1">response</span>.<span class="pl-en">getHits</span>();
        <span class="pl-smi">long</span> <span class="pl-s1">total</span> = <span class="pl-s1">hits</span>.<span class="pl-en">getTotalHits</span>().<span class="pl-s1">value</span>;
        <span class="pl-smi">System</span>.<span class="pl-s1">out</span>.<span class="pl-en">println</span>(<span class="pl-s">"total = "</span> + <span class="pl-s1">total</span>);
        <span class="pl-smi">SearchHit</span>[] <span class="pl-s1">searchHits</span> = <span class="pl-s1">hits</span>.<span class="pl-en">getHits</span>();
        <span class="pl-k">for</span> (<span class="pl-smi">SearchHit</span> <span class="pl-s1">searchHit</span> : <span class="pl-s1">searchHits</span>) {
            <span class="pl-smi">String</span> <span class="pl-s1">json</span> = <span class="pl-s1">searchHit</span>.<span class="pl-en">getSourceAsString</span>();
            <span class="pl-smi">System</span>.<span class="pl-s1">out</span>.<span class="pl-en">println</span>(<span class="pl-s">"每一条数据： "</span> + <span class="pl-s1">json</span>);
        }
    }</pre></div>
<h3>精确查询</h3>
<p>不对用户输入搜索条件分词，根据字段内容精确值匹配。但只能查找keyword、数值、日期、boolean类型的字段。例如：  ids 、  term、   range</p>
<h4>ids</h4>
<p>控制台：</p>
<pre class="notranslate"><code class="notranslate">GET /items/_search
{
  "query": {
    "ids": {
      "values": ["5935273" , "40116238853"]
    }
  }
}

</code></pre>
<p>Java ：</p>
<div class="highlight highlight-source-java"><pre class="notranslate">  <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testSearchIds</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-smi">SearchRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">SearchRequest</span>(<span class="pl-s">"items"</span>);
        <span class="pl-c">// 构建请求参数</span>
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>().<span class="pl-en">query</span>(<span class="pl-smi">QueryBuilders</span>.<span class="pl-en">idsQuery</span>().<span class="pl-en">addIds</span>(<span class="pl-s">"5935273"</span>,<span class="pl-s">"40116238853"</span>));
        
        <span class="pl-smi">SearchResponse</span> <span class="pl-s1">response</span> = <span class="pl-s1">client</span>.<span class="pl-en">search</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);
        <span class="pl-smi">List</span>&lt;<span class="pl-smi">ItemDoc</span>&gt; <span class="pl-s1">itemDocs</span> = <span class="pl-en">handlerResponse</span>(<span class="pl-s1">response</span>);
        <span class="pl-s1">itemDocs</span>.<span class="pl-en">forEach</span>(<span class="pl-smi">System</span>.<span class="pl-s1">out</span>::<span class="pl-s1">println</span>);
    }
```

#### <span class="pl-smi">term</span>  就是 <span class="pl-s1">eq</span>
控制台：</pre></div>
<pre class="notranslate"><code class="notranslate">Java ：
````java


</code></pre>
<h4>range 就是 between</h4>
<p>查询价格大于 200 块的商品<br>
控制台：</p>
<pre class="notranslate"><code class="notranslate">GET /items/_search
{
  "query": {
    "range": {
      "price": {
        "lte": 20000
      }
    }
  }
}
</code></pre>
<p>Java ：</p>
<div class="highlight highlight-source-java"><pre class="notranslate">   <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testSearchRange</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-smi">SearchRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">SearchRequest</span>(<span class="pl-s">"items"</span>);
        <span class="pl-c">// 构建请求参数</span>
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>().<span class="pl-en">query</span>(<span class="pl-smi">QueryBuilders</span>.<span class="pl-en">rangeQuery</span>(<span class="pl-s">"price"</span>).<span class="pl-en">lte</span>(<span class="pl-c1">20000</span>));

        <span class="pl-smi">SearchResponse</span> <span class="pl-s1">response</span> = <span class="pl-s1">client</span>.<span class="pl-en">search</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);
        <span class="pl-smi">List</span>&lt;<span class="pl-smi">ItemDoc</span>&gt; <span class="pl-s1">itemDocs</span> = <span class="pl-en">handlerResponse</span>(<span class="pl-s1">response</span>);
        <span class="pl-s1">itemDocs</span>.<span class="pl-en">forEach</span>(<span class="pl-smi">System</span>.<span class="pl-s1">out</span>::<span class="pl-s1">println</span>);
    }</pre></div>
<h3>1.3.复合查询</h3>
<p>复合查询大致可以分为两类：</p>
<ul>
<li>第一类：基于逻辑运算组合叶子查询，实现组合条件，例如
<ul>
<li>bool</li>
</ul>
</li>
<li>第二类：基于某种算法修改查询时的文档相关性算分，从而改变文档排名。例如：
<ul>
<li>function_score</li>
<li>dis_max</li>
</ul>
</li>
</ul>
<h4>bool查询</h4>
<p>即布尔查询。就是利用逻辑运算来组合一个或多个查询子句的组合。bool查询支持的逻辑运算有：</p>
<ul>
<li>must：必须匹配每个子查询，类似“与”</li>
<li>should：选择性匹配子查询，类似“或”</li>
<li>must_not：必须不匹配，不参与算分，类似“非”</li>
<li>filter：必须匹配，不参与算分<br>
注意：出于性能考虑，与搜索关键字无关的查询尽量采用must_not或filter逻辑运算，避免参与相关性算分。<br>
查询  甘蒂牧场 中价格大于 200 的脱脂牛奶<br>
控制台</li>
</ul>
<pre class="notranslate"><code class="notranslate">GET /items/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "name": "脱脂牛奶"
          }
        }
      ],
      "filter": [
        {
          "term": {
            "brand": "甘蒂牧场"
          },
          "range": {
            "price": {
              "lte": 20000
            }
          }
        }
      ]
    }
  }
}
</code></pre>
<p>java ：</p>
<div class="highlight highlight-source-java"><pre class="notranslate">    <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testSearchDom</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-smi">int</span> <span class="pl-s1">pageNo</span> = <span class="pl-c1">2</span>, <span class="pl-s1">pageSize</span> = <span class="pl-c1">5</span>;
        <span class="pl-c">// 准备 request</span>
        <span class="pl-smi">SearchRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">SearchRequest</span>(<span class="pl-s">"items"</span>);

        <span class="pl-c">// 2.1 构建查询条件</span>
        <span class="pl-smi">BoolQueryBuilder</span> <span class="pl-s1">boolQueryBuilder</span> = <span class="pl-smi">QueryBuilders</span>.<span class="pl-en">boolQuery</span>();
        <span class="pl-s1">boolQueryBuilder</span>.<span class="pl-en">must</span>(<span class="pl-smi">QueryBuilders</span>.<span class="pl-en">matchQuery</span>(<span class="pl-s">"name"</span>, <span class="pl-s">"脱脂牛奶"</span>));
        <span class="pl-s1">boolQueryBuilder</span>.<span class="pl-en">filter</span>(<span class="pl-smi">QueryBuilders</span>.<span class="pl-en">termQuery</span>(<span class="pl-s">"brand"</span>, <span class="pl-s">"甘蒂牧场"</span>));
        <span class="pl-s1">boolQueryBuilder</span>.<span class="pl-en">filter</span>(<span class="pl-smi">QueryBuilders</span>.<span class="pl-en">rangeQuery</span>(<span class="pl-s">"price"</span>).<span class="pl-en">lt</span>(<span class="pl-c1">20000</span>));
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>()
                .<span class="pl-en">query</span>(<span class="pl-s1">boolQueryBuilder</span>);

    
        <span class="pl-c">// 发送请求</span>
        <span class="pl-smi">SearchResponse</span> <span class="pl-s1">response</span> = <span class="pl-s1">client</span>.<span class="pl-en">search</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);
        <span class="pl-c">// 解析结果</span>
        <span class="pl-smi">List</span>&lt;<span class="pl-smi">ItemDoc</span>&gt; <span class="pl-s1">itemDocs</span> = <span class="pl-en">handlerResponse</span>(<span class="pl-s1">response</span>);
        <span class="pl-smi">System</span>.<span class="pl-s1">out</span>.<span class="pl-en">println</span>(<span class="pl-s">"itemDocs = "</span> + <span class="pl-s1">itemDocs</span>);
    }

```
注意：只有字段是 <span class="pl-smi">text</span> 类型是才使用全文检索


### 排序
<span class="pl-s1">elasticsearch</span>默认是根据相关度算分（<span class="pl-s1">_score</span>）来排序，但是也支持自定义方式对搜索结果排序。不过分词字段无法排序，能参与排序字段类型有：<span class="pl-s1">keyword</span>类型、数值类型、地理坐标类型、日期类型等 ，对 <span class="pl-s1">text</span> 类型进行排序没有意义。
对价格进行排序
控制台</pre></div>
<p>GET /items/_search<br>
{<br>
"query": {<br>
"match_all": {}<br>
},<br>
"sort": [<br>
{<br>
"price": {<br>
"order": "desc"<br>
}<br>
}<br>
]<br>
}</p>
<pre class="notranslate"><code class="notranslate">java
````java
 @Test
    void testSearchSort() throws IOException {
        SearchRequest request = new SearchRequest("items");
        // 构建请求参数
        request.source().query(QueryBuilders.matchAllQuery());
        request.source().sort(SortBuilders.fieldSort("price"));

        SearchResponse response = client.search(request, RequestOptions.DEFAULT);
        List&lt;ItemDoc&gt; itemDocs = handlerResponse(response);
        itemDocs.forEach(System.out::println);
    }

</code></pre>
<h3>分页</h3>
<p>elasticsearch 默认情况下只返回top10的数据。而如果要查询更多数据就需要修改分页参数了。</p>
<h4>基础分页</h4>
<p>elasticsearch中通过修改from、size参数来控制要返回的分页结果：</p>
<ul>
<li>from：从第几个文档开始</li>
<li>size：总共查询几个文档<br>
类似于mysql中的limit ?, ?<br>
查询第2页五条数据<br>
控制台</li>
</ul>
<pre class="notranslate"><code class="notranslate">GET /items/_search
{
  "query": {
    "match_all": {}
  },
  "from": 5,
  "size": 5
}

</code></pre>
<p>Java</p>
<div class="highlight highlight-source-java"><pre class="notranslate">    <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testSearchPage</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-smi">SearchRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">SearchRequest</span>(<span class="pl-s">"items"</span>);
        <span class="pl-c">// 构建请求参数</span>
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>().<span class="pl-en">query</span>(<span class="pl-smi">QueryBuilders</span>.<span class="pl-en">matchAllQuery</span>());
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>().<span class="pl-en">from</span>(<span class="pl-c1">5</span>).<span class="pl-en">size</span>(<span class="pl-c1">5</span>);

        <span class="pl-smi">SearchResponse</span> <span class="pl-s1">response</span> = <span class="pl-s1">client</span>.<span class="pl-en">search</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);
        <span class="pl-smi">List</span>&lt;<span class="pl-smi">ItemDoc</span>&gt; <span class="pl-s1">itemDocs</span> = <span class="pl-en">handlerResponse</span>(<span class="pl-s1">response</span>);
        <span class="pl-s1">itemDocs</span>.<span class="pl-en">forEach</span>(<span class="pl-smi">System</span>.<span class="pl-s1">out</span>::<span class="pl-s1">println</span>);
    }</pre></div>
<h3>高亮</h3>
<p>高亮原理：进行给查询的数据中匹配的字条使用标签包裹<br>
给 name 中包含脱脂牛奶的关键字添加高亮效果</p>
<pre class="notranslate"><code class="notranslate">GET /items/_search
{
  "query": {
    "match": {
      "name": "脱脂牛奶"
    }
  },
  "highlight": {
    "fields": {
      "name": {}
    }
  }
}
</code></pre>
<div class="highlight highlight-source-java"><pre class="notranslate">    <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testHighlight</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-c">// 准备 request</span>
        <span class="pl-smi">SearchRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">SearchRequest</span>(<span class="pl-s">"items"</span>);
        <span class="pl-c">// 构建查询条件</span>
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>().<span class="pl-en">query</span>(<span class="pl-smi">QueryBuilders</span>.<span class="pl-en">matchQuery</span>(<span class="pl-s">"name"</span>, <span class="pl-s">"脱脂牛奶"</span>));
        <span class="pl-c">// 构建高亮条件</span>
<span class="pl-c">//        request.source().highlighter(new HighlightBuilder().field("name"));</span>
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>().<span class="pl-en">highlighter</span>(<span class="pl-smi">SearchSourceBuilder</span>.<span class="pl-en">highlight</span>().<span class="pl-en">field</span>(<span class="pl-s">"name"</span>));
        <span class="pl-c">// 发送请求</span>
        <span class="pl-smi">SearchResponse</span> <span class="pl-s1">response</span> = <span class="pl-s1">client</span>.<span class="pl-en">search</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);

        <span class="pl-smi">List</span>&lt;<span class="pl-smi">ItemDoc</span>&gt; <span class="pl-s1">itemDocs</span> = <span class="pl-en">handlerResponse</span>(<span class="pl-s1">response</span>);

        <span class="pl-s1">itemDocs</span>.<span class="pl-en">forEach</span>(<span class="pl-smi">System</span>.<span class="pl-s1">out</span>::<span class="pl-s1">println</span>);

    }</pre></div>
<p>注意点：使用高亮必须要查询的关键字</p>
<h3>数据聚合</h3>
<p>聚合（aggregations）可以让我们极其方便的实现对数据的统计、分析、运算。<br>
聚合常见的有三类：</p>
<ul>
<li>桶（Bucket）聚合：用来对文档做分组</li>
<li>TermAggregation：按照文档字段值分组，例如按照品牌值分组、按照国家分组</li>
<li>Date Histogram：按照日期阶梯分组，例如一周为一组，或者一月为一组</li>
<li>度量（Metric）聚合：用以计算一些值，比如：最大值、最小值、平均值等</li>
<li>Avg：求平均值</li>
<li>Max：求最大值</li>
<li>Min：求最小值</li>
<li>Stats：同时求max、min、avg、sum等</li>
<li>管道（pipeline）聚合：其它聚合的结果为基础做进一步运算</li>
</ul>
<h4>桶中 TermAggregation 查询</h4>
<p>统计在商品索引库中有多少个商品分类<br>
控制台</p>
<pre class="notranslate"><code class="notranslate">GET /items/_search
{
  "size": 0, 
  "aggs": {
    "category_agg": {
      "terms": {
        "field": "category",
        "size": 20
      }
    }
  }
}
</code></pre>
<p>语法说明：</p>
<ul>
<li>size：设置size为0，就是每页查0条，则结果中就不包含文档，只包含聚合</li>
<li>aggs：定义聚合
<ul>
<li>category_agg：聚合名称，自定义，但不能重复
<ul>
<li>terms：聚合的类型，按分类聚合，所以用term
<ul>
<li>field：参与聚合的字段名称</li>
<li>size：希望返回的聚合结果的最大数量<br>
Java</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight highlight-source-java"><pre class="notranslate">  <span class="pl-c1">@</span><span class="pl-c1">Test</span>
    <span class="pl-smi">void</span> <span class="pl-s1">testAgg1</span>() <span class="pl-k">throws</span> <span class="pl-s1">IOException</span> {
        <span class="pl-c">// 准备 request</span>
        <span class="pl-smi">SearchRequest</span> <span class="pl-s1">request</span> = <span class="pl-k">new</span> <span class="pl-smi">SearchRequest</span>(<span class="pl-s">"items"</span>);
        <span class="pl-c">// 构建查询条件</span>
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>().<span class="pl-en">query</span>(<span class="pl-smi">QueryBuilders</span>.<span class="pl-en">matchAllQuery</span>());
        <span class="pl-c">// 构建高亮条件 </span>
        <span class="pl-c">// AggregationBuilders.terms("cate_agg") 设置聚合的类型( terms )  和 聚合的名称(cate_agg)</span>
        <span class="pl-c">// field("category“)  根据哪个字段</span>
        <span class="pl-s1">request</span>.<span class="pl-en">source</span>().<span class="pl-en">aggregation</span>(<span class="pl-smi">AggregationBuilders</span>.<span class="pl-en">terms</span>(<span class="pl-s">"cate_agg"</span>).<span class="pl-en">field</span>(<span class="pl-s">"category"</span>).<span class="pl-en">size</span>(<span class="pl-c1">20</span>));
        <span class="pl-c">// 发送请求</span>
        <span class="pl-smi">SearchResponse</span> <span class="pl-s1">response</span> = <span class="pl-s1">client</span>.<span class="pl-en">search</span>(<span class="pl-s1">request</span>, <span class="pl-smi">RequestOptions</span>.<span class="pl-c1">DEFAULT</span>);

        <span class="pl-smi">List</span>&lt;<span class="pl-smi">ItemDoc</span>&gt; <span class="pl-s1">itemDocs</span> = <span class="pl-en">handlerResponse</span>(<span class="pl-s1">response</span>);

        <span class="pl-s1">itemDocs</span>.<span class="pl-en">forEach</span>(<span class="pl-smi">System</span>.<span class="pl-s1">out</span>::<span class="pl-s1">println</span>);
    }</pre></div>
<h3>总结</h3>
<p>aggs代表聚合，与query同级，此时query的作用是？</p>
<ul>
<li>限定聚合的的文档范围<br>
聚合必须的三要素：</li>
<li>聚合名称</li>
<li>聚合类型</li>
<li>聚合字段<br>
聚合可配置属性有：</li>
<li>size：指定聚合结果数量</li>
<li>order：指定聚合结果排序方式</li>
<li>field：指定聚合字段</li>
</ul></div>
<div style="font-size:small;margin-top:8px;float:right;"></div>

<button class="btn btn-block" type="button" onclick="openComments()" id="cmButton">评论</button>
<div class="comments" id="comments"></div>

</div>
    <div id="footer"><div id="footer1">Copyright © <span id="copyrightYear"></span> <a href="https://2004GIF.github.io/chenzian-shrimp.github.io">陈子安个人博客</a></div>
<div id="footer2">
    <span id="runday"></span><span>Powered by <a href="https://meekdai.com/Gmeek.html" target="_blank">Gmeek</a></span>
</div>

<script>
var now=new Date();
document.getElementById("copyrightYear").innerHTML=now.getFullYear();

if(""!=""){
    var startSite=new Date("");
    var diff=now.getTime()-startSite.getTime();
    var diffDay=Math.floor(diff/(1000*60*60*24));
    document.getElementById("runday").innerHTML="网站运行"+diffDay+"天"+" • ";
}
</script></div>
</body>
<script>
var IconList={'sun': 'M8 10.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V.75A.75.75 0 018 0zm0 13a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 13zM2.343 2.343a.75.75 0 011.061 0l1.06 1.061a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zm9.193 9.193a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061l-1.061-1.06a.75.75 0 010-1.061zM16 8a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0116 8zM3 8a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h1.5A.75.75 0 013 8zm10.657-5.657a.75.75 0 010 1.061l-1.061 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zm-9.193 9.193a.75.75 0 010 1.06l-1.06 1.061a.75.75 0 11-1.061-1.06l1.06-1.061a.75.75 0 011.061 0z', 'moon': 'M9.598 1.591a.75.75 0 01.785-.175 7 7 0 11-8.967 8.967.75.75 0 01.961-.96 5.5 5.5 0 007.046-7.046.75.75 0 01.175-.786zm1.616 1.945a7 7 0 01-7.678 7.678 5.5 5.5 0 107.678-7.678z', 'sync': 'M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z', 'home': 'M6.906.664a1.749 1.749 0 0 1 2.187 0l5.25 4.2c.415.332.657.835.657 1.367v7.019A1.75 1.75 0 0 1 13.25 15h-3.5a.75.75 0 0 1-.75-.75V9H7v5.25a.75.75 0 0 1-.75.75h-3.5A1.75 1.75 0 0 1 1 13.25V6.23c0-.531.242-1.034.657-1.366l5.25-4.2Zm1.25 1.171a.25.25 0 0 0-.312 0l-5.25 4.2a.25.25 0 0 0-.094.196v7.019c0 .138.112.25.25.25H5.5V8.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v5.25h2.75a.25.25 0 0 0 .25-.25V6.23a.25.25 0 0 0-.094-.195Z', 'github': 'M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z', 'copy': 'M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z', 'check': 'M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z'};
var utterancesLoad=0;

let themeSettings={
    "dark": ["dark","moon","#00f0ff","dark-blue"],
    "light": ["light","sun","#ff5000","github-light"],
    "auto": ["auto","sync","","preferred-color-scheme"]
};
function changeTheme(mode, icon, color, utheme){
    document.documentElement.setAttribute("data-color-mode",mode);
    document.getElementById("themeSwitch").setAttribute("d",value=IconList[icon]);
    document.getElementById("themeSwitch").parentNode.style.color=color;
    if(utterancesLoad==1){utterancesTheme(utheme);}
}
function modeSwitch(){
    let currentMode=document.documentElement.getAttribute('data-color-mode');
    let newMode = currentMode === "light" ? "dark" : currentMode === "dark" ? "auto" : "light";
    localStorage.setItem("meek_theme", newMode);
    if(themeSettings[newMode]){
        changeTheme(...themeSettings[newMode]);
    }
}
function utterancesTheme(theme){
    const message={type:'set-theme',theme: theme};
    const iframe=document.getElementsByClassName('utterances-frame')[0];
    iframe.contentWindow.postMessage(message,'https://utteranc.es');
}
if(themeSettings[theme]){changeTheme(...themeSettings[theme]);}
console.log("\n %c Gmeek last https://github.com/Meekdai/Gmeek \n","padding:5px 0;background:#02d81d;color:#fff");
</script>

<script>
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
document.getElementById("pathIssue").setAttribute("d",IconList["github"]);



function openComments(){
    cm=document.getElementById("comments");
    cmButton=document.getElementById("cmButton");
    cmButton.innerHTML="loading";
    span=document.createElement("span");
    span.setAttribute("class","AnimatedEllipsis");
    cmButton.appendChild(span);

    script=document.createElement("script");
    script.setAttribute("src","https://utteranc.es/client.js");
    script.setAttribute("repo","2004GIF/chenzian-shrimp.github.io");
    script.setAttribute("issue-term","title");
    
    if(localStorage.getItem("meek_theme")=="dark"){script.setAttribute("theme","dark-blue");}
    else if(localStorage.getItem("meek_theme")=="light") {script.setAttribute("theme","github-light");}
    else{script.setAttribute("theme","preferred-color-scheme");}
    
    script.setAttribute("crossorigin","anonymous");
    script.setAttribute("async","");
    cm.appendChild(script);

    int=self.setInterval("iFrameLoading()",200);
}

function iFrameLoading(){
    var utterances=document.getElementsByClassName('utterances');
    if(utterances.length==1){
        if(utterances[0].style.height!=""){
            utterancesLoad=1;
            int=window.clearInterval(int);
            document.getElementById("cmButton").style.display="none";
            console.log("utterances Load OK");
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const createClipboardHTML = (codeContent, additionalClasses = '') => `
        <pre class="notranslate"><code class="notranslate">${codeContent}</code></pre>
        <div class="clipboard-container position-absolute right-0 top-0 ${additionalClasses}">
            <clipboard-copy class="ClipboardButton btn m-2 p-0" role="button" style="display: inherit;">
                <svg height="16" width="16" class="octicon octicon-copy m-2"><path d="${IconList["copy"]}"></path></svg>
                <svg height="16" width="16" class="octicon octicon-check color-fg-success m-2 d-none"><path d="${IconList["check"]}"></path></svg>
            </clipboard-copy>
            <div class="copy-feedback">Copied!</div>
        </div>
    `;

    const handleCodeElements = (selector = '') => {
        document.querySelectorAll(selector).forEach(codeElement => {
            const codeContent = codeElement.innerHTML;
            const newStructure = document.createElement('div');
            newStructure.className = 'snippet-clipboard-content position-relative overflow-auto';
            newStructure.innerHTML = createClipboardHTML(codeContent);

            const parentElement = codeElement.parentElement;
            if (selector.includes('highlight')) {
                parentElement.insertBefore(newStructure, codeElement.nextSibling);
                parentElement.removeChild(codeElement);
            } else {
                parentElement.parentElement.replaceChild(newStructure, parentElement);
            }
        });
    };

    handleCodeElements('pre.notranslate > code.notranslate');
    handleCodeElements('div.highlight > pre.notranslate');

    let currentFeedback = null;
    document.querySelectorAll('clipboard-copy').forEach(copyButton => {
        copyButton.addEventListener('click', () => {
            const codeContent = copyButton.closest('.snippet-clipboard-content').innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = codeContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            const copyIcon = copyButton.querySelector('.octicon-copy');
            const checkIcon = copyButton.querySelector('.octicon-check');
            const copyFeedback = copyButton.nextElementSibling;

            if (currentFeedback && currentFeedback !== copyFeedback) {currentFeedback.style.display = 'none';}
            currentFeedback = copyFeedback;

            copyIcon.classList.add('d-none');
            checkIcon.classList.remove('d-none');
            copyFeedback.style.display = 'block';
            copyButton.style.borderColor = 'var(--color-success-fg)';

            setTimeout(() => {
                copyIcon.classList.remove('d-none');
                checkIcon.classList.add('d-none');
                copyFeedback.style.display = 'none';
                copyButton.style.borderColor = '';
            }, 2000);
        });
    });
});

</script>


</html>
